{% extends "base_minimal.html" %}
{% load static %}

{% block title %}Diagnóstico en Curso{% endblock %}

{% block content %}
<div class="relative min-h-screen bg-gradient-to-b from-gray-900 via-gray-950 to-black">

  <!-- BOTÓN SALIR: absoluto en la esquina superior derecha -->
  <a href="{% url 'mainPage' %}"
     class="absolute top-4 right-4 z-50 inline-flex items-center gap-2 px-3 py-1.5 bg-gray-800/80 hover:bg-gray-800/95 text-gray-100 rounded-md shadow-sm transition"
     aria-label="Salir">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-100" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
    <span class="text-sm font-medium">Salir</span>
  </a>

  <!-- Contenedor central -->
  <main class="flex items-center justify-center min-h-screen px-4 py-6">
    <div id="diagnostico-root"
         data-post-url="{{ post_url }}"
         data-duracion="{{diagnostico.duracion_segundos}}"
         data-diagnostico-id="{{ diagnostico.id }}"
         data-fecha-inicio="{{ diagnostico.fecha_inicio|date:'c' }}"
         data-remaining-seconds="{{ remaining_seconds }}"
         class="w-full max-w-4xl bg-gray-900/85 rounded-xl p-6 flex flex-col gap-6 shadow-2xl border border-gray-800 relative">

        <!-- Temporizador superior -->
        <header class="flex justify-between items-center p-3 bg-gray-800 border border-gray-700/50 rounded-lg">
            <h1 class="text-xl font-bold text-gray-100">Prueba de Diagnóstico</h1>
            <div class="flex items-center space-x-2 text-lg font-extrabold text-orange-400">
                <i class="fas fa-clock"></i>
                <div class="time">Tiempo: --:--</div>
            </div>
        </header>

        <!-- Enunciado -->
        <div class="exercise bg-gray-800 border border-gray-700/50 rounded-lg p-5 text-gray-100 text-lg leading-relaxed shadow-inner max-h-48 overflow-auto">
            <p id="enunciado" class="whitespace-pre-wrap">{{ contexto.display_text }}</p>
        </div>

        <input type="hidden" id="ejercicio-id" value="{{ ejercicio.id}}">

        <!-- Paneles -->
        <div class="panels grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Panel Izquierdo - Pasos -->
            <div class="left-panel">
                <div class="steps-box bg-gray-900/50 border border-gray-800 rounded-lg p-4 h-full flex flex-col">
                    <div class="inputs flex flex-col gap-3 overflow-auto max-h-[60vh]" id="steps-container">
                        <input type="text" name="step[]" class="step-input w-full p-3 text-base rounded-md border border-gray-700 bg-gray-900 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Empieza aquí ^^" autofocus />
                    </div>
                    
                    <div class="button-row mt-4 flex flex-wrap gap-3">
                        <button type="button" id="add-step-btn" class="px-5 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition shadow-md flex-1 min-w-[120px]">
                          + Agregar paso
                        </button>
                        <button type="button" id="remove-step-btn" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition shadow-md flex-1 min-w-[120px]">
                          − Quitar paso
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panel Derecho - Pista -->
            <div class="right-panel">
                <div class="hint-box bg-gray-900/50 border border-gray-800 rounded-lg p-4 h-full flex flex-col">
                    <button id="hint-toggle" class="hint-button w-full text-left bg-yellow-500 text-gray-900 font-bold px-4 py-2 rounded-md hover:bg-yellow-600 transition shadow-md">
                      ¿Pista?
                    </button>
                    <div id="hint-text" class="hidden mt-3 p-3 bg-gray-800 border border-gray-700 rounded-md text-gray-200 text-sm leading-relaxed overflow-auto flex-1">
                        <p class="whitespace-pre-wrap">{{ contexto.hint }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- BOTÓN SIGUIENTE EJERCICIO: dentro del contenedor -->
        <div class="flex justify-end mt-2 pt-4 border-t border-gray-800/50">
          <button id="finalize-btn"
                  class="px-6 py-2.5 text-base bg-gradient-to-r from-orange-600 to-orange-500 text-white font-bold rounded-lg hover:scale-[1.03] transition-all shadow-md hover:shadow-orange-500/40 focus:outline-none focus:ring-2 focus:ring-orange-500/30">
            Siguiente Ejercicio
          </button>
        </div>
    </div>
  </main>
  
  <!-- POPUP DE ENVÍO -->
  <div id="sending-popup" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
    <div class="bg-gray-900 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl border border-orange-500/30 transform transition-all">
      <div class="flex flex-col items-center text-center">
        <div class="relative mb-6">
          <!-- Spinner animado -->
          <div class="w-16 h-16 border-4 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
          <div class="absolute inset-0 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
        <h3 class="text-2xl font-bold text-orange-400 mb-2">Cargando siguiente ejercicio</h3>
        <p class="text-gray-300 text-lg">Por favor, espera mientras procesamos tu respuesta...</p>
        <div class="mt-4 flex space-x-1">
          <span class="w-2 h-2 bg-orange-400 rounded-full animate-bounce" style="animation-delay: 0s"></span>
          <span class="w-2 h-2 bg-orange-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
          <span class="w-2 h-2 bg-orange-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_head %}
<script type="module" src="{% static 'js/diagnostico/main.js' %}"></script>
{% endblock %}