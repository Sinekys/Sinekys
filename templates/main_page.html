{% extends "base.html" %}
{% load static %}
{% block title %}Menú Principal - Área de Usuario{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-gray-900 via-gray-800 to-gray-900 py-16 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="mb-12 text-center">
      <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-4 drop-shadow-lg">Área de Usuario</h1>
      <p class="text-lg md:text-xl text-orange-400 font-medium">Comienza tu ruta de aprendizaje personalizada con Sinekys</p>
    </header>

    <!-- Navegación principal -->
    <nav class="mb-10">
      <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <li>
          {% if diagnostico_completado %}
            <a href="{% url 'ejercicio' %}"
               class="block w-full px-6 py-5 bg-gradient-to-r from-orange-500 to-orange-400 text-black font-bold rounded-2xl shadow-lg hover:scale-105 transform transition duration-300 text-center">
              <i class="fas fa-edit mr-2"></i> Ejercicio Individual
            </a>
          {% else %}
            <div class="block w-full px-6 py-5 bg-gray-800 text-gray-400 font-bold rounded-2xl shadow-inner flex items-center justify-center cursor-not-allowed">
              <i class="fas fa-edit mr-2"></i> Ejercicio Individual (Realiza la prueba de diagnostico)
            </div>
          {% endif %}
        </li>

        <li>
          {% if diagnostico_completado %}
            <div class="block w-full px-6 py-5 bg-gray-800 text-gray-500 rounded-2xl shadow-inner flex items-center justify-center cursor-not-allowed">
              <i class="fas fa-lock mr-2"></i> Buscar Grupo (No disponible)
            </div>
          {% else %}
            <div class="block w-full px-6 py-5 bg-gray-800 text-gray-500 rounded-2xl shadow-inner flex items-center justify-center cursor-not-allowed">
              <i class="fas fa-lock mr-2"></i> Buscar Grupo (No disponible)
            </div>
          {% endif %}
        </li>

        <li>
          {% if diagnostico_completado %}
            <div class="block w-full px-6 py-5 bg-gray-800 text-gray-500 rounded-2xl shadow-inner flex items-center justify-center cursor-not-allowed">
              <i class="fas fa-lock mr-2"></i> Continuar Ejercicio Grupal (No disponible)
            </div>
          {% else %}
            <div class="block w-full px-6 py-5 bg-gray-800 text-gray-500 rounded-2xl shadow-inner flex items-center justify-center cursor-not-allowed">
              <i class="fas fa-lock mr-2"></i> Continuar Ejercicio Grupal (No disponible)
            </div>
          {% endif %}
        </li>
      </ul>
    </nav>

    <!-- Diagnóstico -->
    {% if not diagnostico_completado %}
      <section class="bg-gray-800/80 backdrop-blur-md p-8 md:p-10 rounded-3xl shadow-2xl border-l-4 border-yellow-400 mb-12">
        <h2 class="text-2xl md:text-3xl font-extrabold text-white mb-4 flex items-center justify-center gap-3">
          <i class="fas fa-flask text-yellow-400"></i> Diagnóstico Pendiente
        </h2>
        <p class="text-gray-300 text-base md:text-lg mb-6 text-center">
          Para desbloquear tu ruta de aprendizaje debes completar tu diagnóstico. Nuestra IA adaptará el contenido según tu nivel y malla curricular.
        </p>
        <div class="text-center">
          <button id="btn-iniciar-diagnostico" 
                  class="px-8 md:px-10 py-3 md:py-4 bg-gradient-to-r from-orange-500 to-orange-400 text-black font-extrabold rounded-full shadow-xl hover:scale-105 transform transition duration-300">
                     <li><a href="{% url 'diagnostico' %}" >Iniciar Prueba de diagnóstico</a></li>

          </button>
        </div>
      </section>
    {% else %}
      <section class="bg-gray-800/80 backdrop-blur-md p-8 md:p-10 rounded-3xl shadow-2xl border-l-4 border-green-500 mb-12">
        <h2 class="text-2xl md:text-3xl font-extrabold text-white mb-4 flex items-center justify-center gap-3">
          <i class="fas fa-check-circle text-green-500"></i> ¡Diagnóstico Completo!
        </h2>
        <p class="text-gray-300 text-base md:text-lg mb-6 text-center">
          Tu ruta personalizada está lista. Comienza tus ejercicios ahora.
        </p>
        <div class="text-center">
          <a href="{% url 'ejercicio' %}" class="px-8 md:px-10 py-3 md:py-4 bg-gradient-to-r from-orange-500 to-orange-400 text-black font-extrabold rounded-full shadow-xl hover:scale-105 transform transition duration-300">
            Comenzar Práctica
          </a>
        </div>
      </section>
    {% endif %}

    <!-- HISTORIAL: carrusel de últimos intentos -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl md:text-3xl font-extrabold text-white">Últimos ejercicios</h3>
        <p class="text-sm text-gray-400">Últimos 10 intentos</p>
      </div>

      {% if ultimos and ultimos|length > 0 %}
        <div class="relative">
          <button id="prev-btn" aria-label="Anterior"
                  class="hidden md:inline-flex absolute left-0 top-1/2 -translate-y-1/2 z-20 bg-gray-800/75 text-white p-2 md:p-3 rounded-full hover:bg-gray-700">
            <i class="fas fa-chevron-left"></i>
          </button>

          <div id="carousel" class="flex gap-4 overflow-x-auto snap-x snap-mandatory scroll-smooth py-2 px-2">
            {% for intento in ultimos %}
              <article class="min-w-[16rem] sm:min-w-[18rem] md:min-w-[20rem] bg-gradient-to-br from-gray-800 to-gray-900 text-white rounded-2xl p-4 shadow-xl snap-start">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1">
                    <h4 class="text-lg font-bold leading-tight">
                      {{ intento.ejercicio.enunciado|default_if_none:"Ejercicio" }}
                    </h4>
                    <p class="text-xs text-gray-300 mt-1">
                      {% if intento.fecha_intento %}{{ intento.fecha_intento|date:"d M Y H:i" }}{% endif %}
                    </p>
                  </div>

                  <div class="text-right ml-3">
                    {% if intento.puntos %}
                      <div class="text-green-400 font-extrabold text-lg">{{ intento.puntos|floatformat:2 }}</div>
                      <div class="text-xs text-gray-400">Puntos</div>
                    {% else %}
                      <div class="text-gray-400 text-sm">0.0</div>
                    {% endif %}
                  </div>
                </div>

                <div class="mt-3 text-sm text-gray-300">
                  {% if intento.feedbacks and intento.feedbacks|length > 0 %}
                    {% with fb=intento.feedbacks.0 %}
                      {% if fb.contexto_ejercicio %}
                        <p class="text-gray-300 line-clamp-3">{{ fb.contexto_ejercicio|truncatechars:180 }}</p>
                      {% else %}
                        <p class="text-gray-300 line-clamp-3">{{ fb.feedback|truncatechars:180 }}</p>
                      {% endif %}
                    {% endwith %}
                  {% else %}
                    <p class="text-gray-400">Sin feedback aún</p>
                  {% endif %}
                </div>

                <div class="mt-4 flex items-center justify-between">
                  {# Enlazamos a la vista existente 'check-respuesta' que espera UUID #}
                  {% if intento.uuid %}
                    <a href="{% url 'check-respuesta' intento.uuid %}"
                       class="text-sm bg-orange-500/90 px-3 py-2 rounded-full font-semibold hover:scale-105 transform transition">
                      Ver
                    </a>
                  {% else %}
                    <span class="text-sm bg-gray-700 px-3 py-2 rounded-full text-gray-300">Ver</span>
                  {% endif %}
                  <span class="text-xs text-gray-400">Intento #{{ forloop.counter }}</span>
                </div>
              </article>
            {% endfor %}
          </div>

          <button id="next-btn" aria-label="Siguiente"
                  class="hidden md:inline-flex absolute right-0 top-1/2 -translate-y-1/2 z-20 bg-gray-800/75 text-white p-2 md:p-3 rounded-full hover:bg-gray-700">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      {% else %}
        <p class="text-gray-300">Aún no tienes intentos registrados. Comienza practicando para que aparezcan en tu historial.</p>
      {% endif %}
    </section>

  </div>
</div>

<!-- Modal de confirmación (diagnóstico) -->
<div id="modal-confirmacion" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[1000] flex justify-center items-center p-4">
  <div class="bg-gray-900/95 text-white p-6 md:p-8 rounded-3xl max-w-lg w-full shadow-2xl border border-gray-700">
    <h3 class="text-2xl font-bold text-orange-400 mb-3 text-center">⚠️ Importante</h3>
    <p class="text-gray-300 text-base mb-2 text-center">La prueba dura <strong class="text-yellow-400">1 hora</strong> y no se puede pausar.</p>
    <p class="text-xl font-semibold text-center mt-4">¿Deseas continuar?</p>
    <div class="mt-6 flex justify-center space-x-3">
      <button id="btn-cancelar" class="px-5 py-2 bg-gray-700 text-white font-semibold rounded-full hover:bg-gray-600">Cancelar</button>
      <a href="{% url 'diagnostico' %}" class="px-5 py-2 bg-green-600 text-white font-semibold rounded-full hover:bg-green-500">Sí, comenzar</a>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const carousel = document.getElementById('carousel');
    const prev = document.getElementById('prev-btn');
    const next = document.getElementById('next-btn');

    function scrollByCard(direction) {
      if (!carousel) return;
      const card = carousel.querySelector('article');
      if (!card) return;
      const gap = parseInt(getComputedStyle(carousel).gap) || 16;
      const amount = card.offsetWidth + gap;
      carousel.scrollBy({ left: direction * amount, behavior: 'smooth' });
    }

    if (prev) prev.addEventListener('click', () => scrollByCard(-1));
    if (next) next.addEventListener('click', () => scrollByCard(1));

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') scrollByCard(-1);
      if (e.key === 'ArrowRight') scrollByCard(1);
    });

    function updateButtons() {
      if (!carousel || !prev || !next) return;
      prev.classList.toggle('hidden', carousel.scrollLeft <= 5);
      next.classList.toggle('hidden', Math.abs(carousel.scrollLeft + carousel.clientWidth - carousel.scrollWidth) < 5);
    }
    if (carousel) {
      carousel.addEventListener('scroll', () => window.requestAnimationFrame(updateButtons));
      window.addEventListener('resize', updateButtons);
      updateButtons();
    }
  })();

  (function(){
    const btn = document.getElementById('btn-iniciar-diagnostico');
    const modal = document.getElementById('modal-confirmacion');
    const cancelar = document.getElementById('btn-cancelar');

    if (btn && modal) {
      btn.addEventListener('click', () => {
        modal.classList.remove('hidden'); modal.classList.add('flex');
      });
    }
    if (cancelar && modal) {
      cancelar.addEventListener('click', () => { modal.classList.remove('flex'); modal.classList.add('hidden'); });
    }
  })();
</script>
{% endblock %}
